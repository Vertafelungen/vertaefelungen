# .github/workflows/sync-from-sheet.yml
# ------------------------------------------------------------
# Sync from Google Sheet → erzeugt Markdown + produkte.{de,en}.json
# Version: 2025-09-13 (Bitte Zeit ggf. lokal ergänzen)
# ------------------------------------------------------------

name: Sync from Sheet

on:
  workflow_dispatch: {}
  # optional: zeitgesteuert
  # schedule:
  #   - cron: "17 */6 * * *"   # alle 6h

permissions:
  contents: write   # für Commit/Push der erzeugten Dateien

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (requirements.txt preferred)
        run: |
          set -euo pipefail
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback – sollte normalerweise nicht nötig sein
            pip install gspread oauth2client PyYAML markdown
          fi

      # Service-Account nur schreiben, wenn Secret gesetzt ist
      - name: Write Google service account (if provided)
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        if: env.GOOGLE_SERVICE_ACCOUNT_JSON != ''
        run: |
          set -euo pipefail
          echo "$GOOGLE_SERVICE_ACCOUNT_JSON" > service-account.json
          echo "service-account.json written."

      # Wichtig: SHEET_ID → SHEET_KEY mappen, damit dein Script weiter funktioniert
      - name: Generate Markdown & produkte.{de,en}.json
        env:
          SHEET_KEY: ${{ secrets.SHEET_ID }}          # Mapping!
          SHEET_GID: ${{ secrets.SHEET_GID }}
          SHEET_CSV_URL: ${{ secrets.SHEET_CSV_URL }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          set -euo pipefail
          if [ -z "${SHEET_KEY:-}" ] && [ -z "${SHEET_CSV_URL:-}" ]; then
            echo "SHEET_KEY (oder SHEET_CSV_URL) muss gesetzt sein." >&2
            exit 1
          fi
          python sync-from-sheet.py

      - name: Commit and push changes (MD + JSON)
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Nur committen, wenn es Änderungen gibt
          if ! git diff --quiet; then
            git add -A
            git commit -m "chore(sync): update content & produkte JSONs"
            git push
          else
            echo "No changes to commit."
          fi
