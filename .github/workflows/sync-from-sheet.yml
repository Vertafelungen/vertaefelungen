name: "SSOT → Repo (Sync Google Sheet → Markdown)"

on:
  workflow_dispatch:
  push:
    paths:
      - "wissen/scripts/**"
      - ".github/workflows/ssot-sync.yml"
  schedule:
    - cron: "15 4 * * *"  # täglich 04:15 UTC

permissions:
  contents: write

jobs:
  ssot_sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      # 1) Sheet → Markdown
      - name: Generate Markdown from SSOT
        env:
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL }}
          GSHEET_CSV_URL_DE: ${{ secrets.GSHEET_CSV_URL_DE }}
          GSHEET_CSV_URL_EN: ${{ secrets.GSHEET_CSV_URL_EN }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          python wissen/scripts/sync-from-sheet.py

      # 2) Sanitize (NBSP/Zero-Width, BOM, Smart Quotes)
      - name: Sanitize content (remove NBSP/Zero-Width/SmartQuotes)
        run: |
          python - <<'PY'
          from pathlib import Path
          import sys
          ROOT = Path(__file__).resolve().parents[2]
          content = ROOT / "wissen" / "content"
          bad = dict(
            nbsp="\u00A0", zwsp="\u200B", zwnj="\u200C", zwj="\u200D", bom="\uFEFF",
            ldq="\u201C", rdq="\u201D", lsq="\u2018", rsq="\u2019", en="\u2013", em="\u2014"
          )
          rep = {bad["ldq"]:'"', bad["rdq"]:'"', bad["lsq"]:"'", bad["rsq"]:"'", bad["en"]:"-", bad["em"]:"-"}
          cnt=0
          for p in content.rglob("*.md"):
            t = p.read_text(encoding="utf-8", errors="replace")
            t2 = t.replace(bad["nbsp"], " ").replace(bad["bom"], "")
            for k in ("zwsp","zwnj","zwj"):
              t2 = t2.replace(bad[k], "")
            for k,v in rep.items():
              t2 = t2.replace(k, v)
            if t2 != t:
              p.write_text(t2, encoding="utf-8")
              cnt += 1
          print(f"[sanitize] changed={cnt}")
          PY

      # 3) Offene Header "***" → "---", fehlenden Abschluss ergänzen (falls nötig)
      - name: Repair malformed frontmatter (open header)
        run: |
          python wissen/scripts/repair_frontmatter_open.py

      # 4) QUOTING & TYPES: riskante Strings quoten, price_cents→int, in_stock→bool
      - name: Normalize YAML values (quote + list split + type coercion)
        run: |
          python wissen/scripts/normalize_yaml_values.py

      # 5) Strenger Inhaltsschutz: bricht bei YAML-Fehlern ab
      - name: Content Guard (strict)
        run: |
          python wissen/scripts/content_guard.py --strict

      # 6) Commit & push nur bei Änderungen
      - name: Commit & push (only if changed)
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "ci(ssot): sanitize + normalize frontmatter (quotes/types) + sync sheet → markdown"
            git push
          else
            echo "No changes."
          fi
