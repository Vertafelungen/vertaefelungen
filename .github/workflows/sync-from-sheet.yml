name: "SSOT → Repo (Sync Google Sheet → Markdown)"

on:
  workflow_dispatch:
  schedule:
    - cron: "17 */6 * * *"  # alle 6 Stunden

permissions:
  contents: write

concurrency:
  group: ssot-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ssot_sync:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wissen

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Generate Markdown from SSOT
        env:
          # Mapping auf deine vorhandenen Secrets
          PRODUCTS_SHEET_CSV: ${{ secrets.GSHEET_CSV_URL }}
          # Optional (nur setzen, wenn vorhanden):
          # FAQ_SHEET_CSV: ${{ secrets.GSHEET_FAQ_CSV_URL }}
        run: |
          python scripts/sync-from-sheet.py

      - name: Sanitize content (remove NBSP/Zero-Width/C0/C1, normalize newlines)
        run: |
          python - <<'PY'
          import re
          from pathlib import Path

          ROOT = Path("wissen")
          CONTENT = ROOT / "content"

          BOM = "\ufeff"
          NBSP = "\u00A0"
          ZERO = {"\u200B","\u200C","\u200D","\u2060","\uFEFF","\u200E","\u200F"}

          # C0 (00–1F), DEL (7F) und C1 (80–9F)
          CTRL_RE = re.compile(r'[\x00-\x1F\x7F-\x9F]')

          def clean(s: str) -> str:
            s = s.replace("\r\n","\n").replace("\r","\n").replace(BOM,"")
            s = s.replace(NBSP," ")
            for z in ZERO: s = s.replace(z,"")
            # typische Windows-1252-Ersatzabbildung
            s = (s
              .replace("\u0096","-")   # en dash
              .replace("\u0097","-")   # em dash
              .replace("\u0091","'")   # left single quote
              .replace("\u0092","'")   # right single quote
              .replace("\u0093","\"")  # left double quote
              .replace("\u0094","\"")  # right double quote
              .replace("\u0085","...") # ellipsis
            )
            # verbleibende C0/C1/DEL → Leerzeichen
            s = CTRL_RE.sub(" ", s)
            return s

          changed = 0
          for p in CONTENT.rglob("*.md"):
            try:
              t = p.read_text(encoding="utf-8")
            except Exception:
              continue
            nt = clean(t)
            if nt != t:
              p.write_text(nt, encoding="utf-8")
              changed += 1
          print(f"Sanitized files: {changed}")
          PY

      - name: Content Guard (strict)
        run: |
          python scripts/content_guard.py --strict

      - name: Commit & push (only if changed)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "ci(ssot): sanitize content (C0/C1) + sync sheet → markdown"
            git push origin HEAD:main
          else
            echo "No content changes."
          fi
