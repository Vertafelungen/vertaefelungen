# .github/workflows/sync-from-sheet.yml
# Version: 2025-09-11 07:00 (Europe/Berlin)
# Purpose: Pull data from Google Sheet -> generate Markdown + JSON via sync-from-sheet.py
# Notes:
# - Install Python deps (either from requirements.txt or fallback to explicit list)
# - Commit changed files created by sync-from-sheet.py

name: Sync from Sheet

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"           # täglich 03:17 UTC (anpassen/entfernen, falls nicht gewünscht)

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (requirements.txt preferred)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f requirements.txt ]]; then
            echo "Installing from requirements.txt…"
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "No requirements.txt found – installing explicit deps…"
            python -m pip install --upgrade pip
            # gspread + its auth stack; add requests/PyYAML if your script uses them
            pip install \
              gspread \
              google-auth \
              google-auth-oauthlib \
              google-auth-httplib2 \
              requests \
              PyYAML \
              pandas
          fi
          python -c "import sys; print('Python:', sys.version)"
          python -c "import pkgutil; print('gspread installed?:', bool(pkgutil.find_loader('gspread')))"

      # Falls dein Script Service-Account-Creds aus einem Secret zieht, stelle
      # das Secret hier zur Verfügung (Beispiel: GOOGLE_SERVICE_ACCOUNT_JSON):
      # - name: Write Google service account credentials (optional)
      #   if: env.GOOGLE_SERVICE_ACCOUNT_JSON != ''
      #   env:
      #     GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      #   run: |
      #     echo "$GOOGLE_SERVICE_ACCOUNT_JSON" > service_account.json

      - name: Generate Markdown & produkte.{de,en}.json
        shell: bash
        run: |
          set -euo pipefail
          python sync-from-sheet.py

      - name: Commit and push changes (MD + JSON)
        shell: bash
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          set -euo pipefail
          git status --porcelain
          if [[ -n "$(git status --porcelain)" ]]; then
            TS="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git add -A
            git commit -m "sync-from-sheet: update content ($TS)"
            git push
          else
            echo "No content changes."
          fi
