name: SSOT → Repo (Sync Google Sheet → Markdown)

on:
  workflow_dispatch:
  schedule:
    # optional: täglicher Sync um 03:00 UTC
    - cron: "0 3 * * *"

permissions:
  contents: write

concurrency:
  group: ssot_sync
  cancel-in-progress: false

jobs:
  ssot_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "wissen/tools/requirements-ssot.txt" ]; then
            pip install -r wissen/tools/requirements-ssot.txt
          else
            echo "requirements-ssot.txt fehlt – installiere Minimal-Set."
            pip install requests PyYAML ruamel.yaml python-slugify chardet
          fi

      - name: Generate Markdown from SSOT
        env:
          # Falls dein Skript diese ENV-Variablen nutzt:
          GSHEET_CSV_URL:     ${{ secrets.GSHEET_CSV_URL }}
          GSHEET_CSV_URL_DE:  ${{ secrets.GSHEET_CSV_URL_DE }}
          GSHEET_CSV_URL_EN:  ${{ secrets.GSHEET_CSV_URL_EN }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          python wissen/scripts/sync-from-sheet.py

      # Sicherheitsnetz: unsichtbare/“smarte” Zeichen und CRLF vereinheitlichen
      - name: Sanitize content (remove NBSP/Zero-Width/SmartQuotes)
        run: |
          python - <<'PY'
          import pathlib
          ROOT = pathlib.Path("wissen/content")
          if ROOT.exists():
              repl = {
                  "\u00A0": " ",   # NBSP
                  "\u200B": "",    # ZWSP
                  "\u200C": "",    # ZWNJ
                  "\u201C": "\"",  # “
                  "\u201D": "\"",  # ”
                  "\u2018": "'",   # ‘
                  "\u2019": "'",   # ’
              }
              for p in ROOT.rglob("*.md"):
                  s = p.read_text(encoding="utf-8", errors="ignore")
                  for k,v in repl.items():
                      s = s.replace(k, v)
                  s = s.replace("\r\n", "\n").replace("\r", "\n")
                  p.write_text(s, encoding="utf-8")
          PY

      # Frontmatter-Reparatur (offene Header o. Ä.) – nur wenn Skript vorhanden
      - name: Repair malformed frontmatter (open header)
        run: |
          if [[ -f "wissen/scripts/repair_frontmatter_open.py" ]]; then
            python wissen/scripts/repair_frontmatter_open.py
          elif [[ -f "wissen/scripts/fix_frontmatter.py" ]]; then
            python wissen/scripts/fix_frontmatter.py
          else
            echo "Kein Frontmatter-Repair-Skript gefunden – Schritt übersprungen."
          fi

      # YAML-Normalisierung (Quotes, Listen splitten, Typen coerzen) – falls vorhanden
      - name: Normalize YAML values (quote + list split + type coercion)
        run: |
          if [[ -f "wissen/scripts/repair_frontmatter_values.py" ]]; then
            python wissen/scripts/repair_frontmatter_values.py
          elif [[ -f "wissen/scripts/normalize_all_md_frontmatter.py" ]]; then
            python wissen/scripts/normalize_all_md_frontmatter.py
          else
            echo "Kein Normalizer-Skript gefunden – Schritt übersprungen."
          fi

      # Strenger Inhaltswächter – bricht bei YAML-/Strukturfehlern ab (so gewollt)
      - name: Content Guard (strict)
        run: |
          if [[ -f "wissen/scripts/content_guard.py" ]]; then
            python wissen/scripts/content_guard.py --strict
          else
            echo "content_guard.py nicht gefunden – Schritt übersprungen."
          fi

      - name: Commit & push (only if changed)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "ci(ssot): sanitize + normalize + sync sheet → markdown"
            git push
          else
            echo "No changes."
          fi
