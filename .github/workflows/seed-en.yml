name: Seed EN bundles

on:
  workflow_dispatch:
    inputs:
      apply:
        description: 'Änderungen anwenden? (false = Dry-Run)'
        required: true
        default: 'false'
        type: choice
        options: ['false','true']

permissions:
  contents: write
  pull-requests: write

jobs:
  seed-en:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Dry-Run: Ordner & Bilder laut SSOT-Slugs planen (keine Dateien schreiben)
      - name: Dry-run seed (SSOT-aware, images-only)
        run: |
          python tools/seed_en_from_de.py \
            --mode images-only \
            --ssot-csv "wissen/ssot/SSOT.csv"

      - name: Upload seed report
        uses: actions/upload-artifact@v4
        with:
          name: seed-en-report
          path: tools/reports/seed-en-*.md

      # Apply: Ordner anlegen + Bilder kopieren (index.md wird NICHT geschrieben)
      - name: Apply & stage (copy files)
        if: ${{ github.event.inputs.apply == 'true' }}
        run: |
          python tools/seed_en_from_de.py \
            --mode images-only \
            --ssot-csv "wissen/ssot/SSOT.csv" \
            --apply
          git add -A

      # Validierung über gesamten Content (DE+EN):
      # - keine .md-Links
      # - keine fehlenden Bild-Referenzen
      - name: Validate links & images (DE+EN)
        if: ${{ github.event.inputs.apply == 'true' }}
        run: |
          python tools/validate_links_and_images.py --content-root "wissen/content"

      # PR mit den neu erzeugten EN-Bundles & kopierten Bildern erstellen
      - name: Create Pull Request
        if: ${{ github.event.inputs.apply == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/seed-en
          title: 'chore(wissen): seed EN product bundles (images-only, SSOT slugs)'
          commit-message: 'chore(wissen): seed EN product bundles (images-only, SSOT slugs)'
          labels: chore
