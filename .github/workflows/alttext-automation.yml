# .github/workflows/alttext-automation.yml
# Version: 2026-01-28 21:00 CET
# Purpose: Manual alttext automation; optional Google service-account JSON provided via GitHub Secret.
# Notes:
# - Do NOT reference secrets.* in "if:" conditionals (GitHub validation error).
# - Instead, expose secret as job env and perform checks inside the shell step.

name: Alttext Automation (manual)

on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  alttext-automation:
    runs-on: ubuntu-latest

    env:
      # Repository Secret name must be exactly: GOOGLE_SERVICE_ACCOUNT_JSON
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install -r tools/requirements-ssot.txt

      - name: Write service account JSON to temp file (optional)
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${GOOGLE_SERVICE_ACCOUNT_JSON:-}" ]]; then
            printf '%s' "${GOOGLE_SERVICE_ACCOUNT_JSON}" > "${RUNNER_TEMP}/gcp-service-account.json"
            echo "GOOGLE_APPLICATION_CREDENTIALS=${RUNNER_TEMP}/gcp-service-account.json" >> "${GITHUB_ENV}"
            echo "Service account JSON provided -> GOOGLE_APPLICATION_CREDENTIALS set."
          else
            echo "No GOOGLE_SERVICE_ACCOUNT_JSON provided -> continuing without service account credentials."
          fi

      - name: Run alttext automation (dry-run)
        run: |
          set -euo pipefail
          python tools/alttext_automatisierung.py
