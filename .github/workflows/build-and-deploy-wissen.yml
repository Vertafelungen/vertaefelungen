name: Build & Deploy Wissen

on:
  push:
    branches: [ main ]
    paths:
      - 'scripts/build_site.py'                # Build-Script
      - 'de/oeffentlich/**'                    # DE-Content
      - 'en/public/**'                         # EN-Content
      - '.github/workflows/build-and-deploy-wissen.yml'
  workflow_dispatch:

env:
  BASE_URL: https://www.vertaefelungen.de/wissen
  CONTENT_ROOT: .
  EXCLUDE_DIRS: .github,docs,interne-prozesse,internal-processes,general-information,scripts,tools

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install markdown pyyaml

      - name: Sanity check
        run: |
          ls -la
          test -f scripts/build_site.py || (echo "scripts/build_site.py fehlt" && exit 1)

      - name: Build site
        env:
          BASE_URL: ${{ env.BASE_URL }}
          CONTENT_ROOT: ${{ env.CONTENT_ROOT }}
          EXCLUDE_DIRS: ${{ env.EXCLUDE_DIRS }}
        run: |
          python scripts/build_site.py
          echo "Built output:"
          find site -maxdepth 3 -type f | head -n 100

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wissen-site
        path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wissen-site
          path: site

      - name: Check SFTP inputs
        run: |
          [ -n "${{ secrets.SFTP_HOST }}" ] || (echo "SFTP_HOST secret fehlt" && exit 1)
          [ -n "${{ secrets.SFTP_USER }}" ] || (echo "SFTP_USER secret fehlt" && exit 1)
          [ -n "${{ secrets.SFTP_PASSWORD }}" ] || (echo "SFTP_PASSWORD secret fehlt" && exit 1)
          echo "Port: ${{ secrets.SFTP_PORT || '22' }}"
          echo "Remote path: /holzvertaefelung-store/wissen"

      - name: Deploy via SFTP (password auth)
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server:      ${{ secrets.SFTP_HOST }}                 # z.B. home98215036.1and1-data.host
          port:        ${{ secrets.SFTP_PORT || '22' }}         # Standard: 22
          username:    ${{ secrets.SFTP_USER }}                 # z.B. acc12345678
          password:    ${{ secrets.SFTP_PASSWORD }}             # Webspace-Passwort
          local_path:  "site/*"
          remote_path: "/holzvertaefelung-store/wissen"         # Zielordner lt. Screenshot
          sftp_only:   true
