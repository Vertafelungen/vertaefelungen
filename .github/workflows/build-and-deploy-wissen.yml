# build-and-deploy-wissen.yml
# Vertäfelungen – Wissen (Hugo)
# Version: 2026-01-23 12:37 CET
#
# CHANGELOG (2026-01-23):
# - Deploy-Fix: Dotfiles (insb. .htaccess) werden jetzt sicher mit ausgerollt.
#   Ursache: source "wissen/public/**" matched i. d. R. keine Dotfiles -> .htaccess fehlte live.
# - Added: Hard check that public/.htaccess exists after build (fails fast).
# - Added: Inspect step shows dotfiles (ls -la public).

name: Build & Deploy Wissen (Hugo)

on:
  push:
    branches: [ main ]
    paths:
      - 'wissen/**'
      - '.github/workflows/build-and-deploy-wissen.yml'
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wissen

    steps:
      - name: Checkout (mit Submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python 3.12 (für Hilfs-Tools)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache Hugo binary
        uses: actions/cache@v4
        with:
          path: wissen/tools/hugo
          key: hugo-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('wissen/tools/hugo/VERSION') }}

      - name: Install Hugo (repo-local)
        run: ./tools/hugo/install.sh

      - name: Build (production)
        env:
          HUGO_ENV: production
        run: |
          ./tools/hugo/hugo --minify --gc --config "hugo.prod.toml"
          date -u +"%Y-%m-%dT%H:%M:%SZ  $GITHUB_SHA" > public/deploy-stamp.txt

      # kleine Sicherung: zeige, dass der Build-Output da ist (inkl. Dotfiles)
      - name: Inspect build output
        run: |
          pwd
          du -sh public || true
          echo "== public (incl. dotfiles) =="
          ls -la public | head -n 200
          echo "== sample files =="
          find public -maxdepth 2 -type f | head -n 50

      # HARTE SICHERUNG: .htaccess muss im Build-Output existieren, sonst ist UTF-8 Fix live wirkungslos
      - name: Assert .htaccess is present in build output
        run: |
          test -f public/.htaccess || (echo "ERROR: public/.htaccess missing. Ensure wissen/static/.htaccess exists and is copied by Hugo." && exit 1)

      - name: Run mojibake scan
        run: |
          python scripts/check_mojibake.py --root public --report artifacts/mojibake_report.json

      - name: Upload mojibake report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mojibake-report
          path: wissen/artifacts/mojibake_report.json

      - name: Check deploy secrets (hart brechen wenn was fehlt)
        run: |
          test -n "${{ secrets.SFTP_HOST }}"        || (echo "Missing secret SFTP_HOST" && exit 1)
          test -n "${{ secrets.SFTP_USERNAME }}"    || (echo "Missing secret SFTP_USERNAME" && exit 1)
          test -n "${{ secrets.SFTP_PASSWORD }}"    || (echo "Missing secret SFTP_PASSWORD" && exit 1)
          test -n "${{ secrets.SFTP_PORT }}"        || (echo "Missing secret SFTP_PORT" && exit 1)
          test -n "${{ secrets.SFTP_TARGET }}"      || (echo "Missing secret SFTP_TARGET" && exit 1)

      - name: SSH cleanup target (wissen)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          script: |
            set -e
            cd "${{ secrets.SFTP_TARGET }}"
            rm -f index.html robots.txt sitemap.xml deploy-stamp.txt version.json
            rm -rf de en faq .deploy .deploy-stamp .hugo_build_lock

      - name: Deploy via SCP (wissen/public -> TARGET) incl. dotfiles (.htaccess)
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          # Wichtig: Pfad relativ zum Repo-Root!
          # NOTE: Use directory source (NOT glob) to include dotfiles like .htaccess.
          source:   "wissen/public"
          target:   ${{ secrets.SFTP_TARGET }}
          # 'wissen/public' abstreifen => 2 Komponenten
          strip_components: 2
          overwrite: true

      - name: Done
        run: echo "Deployed to ${{ secrets.SFTP_TARGET }}"
