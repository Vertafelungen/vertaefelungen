# build-and-deploy-wissen.yml
# Vertäfelungen – Wissen (Hugo)
# Version: 2025-11-02 09:43 CET

name: Build & Deploy Wissen (Hugo)

on:
  push:
    branches: [ "main" ]
    paths:
      - "wissen/**"
      - ".github/workflows/build-and-deploy-wissen.yml"
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "latest"
          extended: true

      # --- Build ---
      - name: Build (minified, production)
        run: |
          hugo --minify -gc -s wissen --environment production

      # --- Secrets check (hard fail if missing) ---
      - name: Check deploy secrets
        shell: bash
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_TARGET: ${{ secrets.SFTP_TARGET }}
        run: |
          test -n "$SFTP_HOST"      || { echo "Missing secret SFTP_HOST" && exit 1; }
          test -n "$SFTP_PORT"      || { echo "Missing secret SFTP_PORT" && exit 1; }
          test -n "$SFTP_USERNAME"  || { echo "Missing secret SFTP_USERNAME" && exit 1; }
          test -n "$SFTP_PASSWORD"  || { echo "Missing secret SFTP_PASSWORD" && exit 1; }
          test -n "$SFTP_TARGET"    || { echo "Missing secret SFTP_TARGET" && exit 1; }
          echo "All required secrets present."

      # --- Cleanup remote target (safe guarded) ---
      - name: SSH cleanup target (${{ secrets.SFTP_TARGET }})
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          script: |
            set -euo pipefail
            TARGET="${{ secrets.SFTP_TARGET }}"
            # Safety guard: nur auf die zwei erlaubten Ziele reagieren
            case "$TARGET" in
              wissen|holzvertaefelung-store/wissen) ;;
              *) echo "Refuse to clean unexpected target: $TARGET" ; exit 1 ;;
            esac
            mkdir -p "$TARGET"
            rm -rf "$TARGET"/*

      # --- Deploy via SCP ---
      - name: Deploy via SCP (copy wissen/public/* → ${{ secrets.SFTP_TARGET }})
        uses: appleboy/scp-action@v0.1.7
        with:
          host:              ${{ secrets.SFTP_HOST }}
          username:          ${{ secrets.SFTP_USERNAME }}
          password:          ${{ secrets.SFTP_PASSWORD }}
          port:              ${{ secrets.SFTP_PORT }}
          source:            "wissen/public/*"
          target:            ${{ secrets.SFTP_TARGET }}
          strip_components:  2
          overwrite:         true

