name: Build & Deploy Wissen

on:
  push:
    branches: [ main ]
    paths:
      - 'build_site.py'
      - 'wissen/**'           # <— passe an: dein Inhaltsordner im Repo
      - '.github/workflows/build-and-deploy-wissen.yml'
  workflow_dispatch:

env:
  # BASE_URL MUSS auf die endgültige Ziel-URL von /wissen zeigen
  BASE_URL: https://www.vertaefelungen.de/wissen
  # CONTENT_ROOT ist der Ordner im Repo, in dem deine .md liegen (z. B. 'wissen' oder '.')
  CONTENT_ROOT: wissen
  # Kommagetrennte Ordnernamen, die beim Rendern ignoriert werden sollen (optional)
  EXCLUDE_DIRS: node_modules,.git,dist,public

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install markdown pyyaml

      - name: Build site
        env:
          BASE_URL: ${{ env.BASE_URL }}
          CONTENT_ROOT: ${{ env.CONTENT_ROOT }}
          EXCLUDE_DIRS: ${{ env.EXCLUDE_DIRS }}
        run: |
          python build_site.py
          echo "Build complete. Output:"
          ls -la site | head -n 50

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wissen-site
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wissen-site
          path: site

      # Variante A: SFTP-Deploy (IONOS Webspace)
      - name: Deploy via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          port: ${{ secrets.SFTP_PORT }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          local_path: "site/*"
          remote_path: "www/wissen"    # ggf. anpassen: dein Zielordner
          sftp_only: true

      # Variante B (optional): rsync mit Deploy-Key
      # - name: Deploy via rsync
      #   uses: burnett01/rsync-deployments@6.0.0
      #   with:
      #     switches: -avzr --delete
      #     path: site/
      #     remote_path: ${{ secrets.RSYNC_REMOTE_PATH }}
      #     remote_host: ${{ secrets.RSYNC_REMOTE_HOST }}
      #     remote_user: ${{ secrets.RSYNC_REMOTE_USER }}
      #     remote_key: ${{ secrets.RSYNC_SSH_KEY }}
