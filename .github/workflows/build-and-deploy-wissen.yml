# build-and-deploy-wissen.yml
# Vertäfelungen – Wissen (Hugo)
# Version: 2025-11-02 10:19 CET

name: Build & Deploy Wissen (Hugo)

on:
  push:
    branches: [ main ]
    paths:
      - 'wissen/**'
      - '.github/workflows/build-and-deploy-wissen.yml'
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wissen

    steps:
      - name: Checkout (mit Submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python 3.12 (für Hilfs-Tools)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Read Hugo version
        id: hugover
        working-directory: .
        run: echo "version=$(cat wissen/tools/hugo/VERSION)" >> "$GITHUB_OUTPUT"

      - name: Detect arch
        id: arch
        working-directory: .
        run: |
          case "$(uname -m)" in
            x86_64) arch="amd64" ;;
            aarch64|arm64) arch="arm64" ;;
            *) arch="$(uname -m)" ;;
          esac
          echo "arch=$arch" >> "$GITHUB_OUTPUT"

      - name: Cache Hugo binary
        uses: actions/cache@v4
        with:
          path: wissen/tools/hugo/
          key: hugo-${{ runner.os }}-${{ steps.arch.outputs.arch }}-${{ steps.hugover.outputs.version }}
          restore-keys: |
            hugo-${{ runner.os }}-${{ steps.arch.outputs.arch }}-
            hugo-${{ runner.os }}-

      - name: Install Hugo (repo-local)
        working-directory: .
        run: |
          chmod +x wissen/tools/hugo/install.sh wissen/tools/hugo/hugo
          ./wissen/tools/hugo/install.sh

      - name: Hugo version
        working-directory: .
        run: ./wissen/tools/hugo/hugo version

      - name: Build (production)
        working-directory: .
        env:
          HUGO_ENV: production
        run: |
          ./wissen/tools/hugo/hugo -s wissen --minify --gc --config "wissen/hugo.prod.toml"
          date -u +"%Y-%m-%dT%H:%M:%SZ  $GITHUB_SHA" > wissen/public/deploy-stamp.txt

      # kleine Sicherung: zeige, dass der Build-Output da ist
      - name: Inspect build output
        working-directory: wissen
        run: |
          pwd
          du -sh public || true
          find public -maxdepth 2 -type f | head -n 50

      - name: Check deploy secrets (hart brechen wenn was fehlt)
        run: |
          test -n "${{ secrets.SFTP_HOST }}"        || (echo "Missing secret SFTP_HOST" && exit 1)
          test -n "${{ secrets.SFTP_USERNAME }}"    || (echo "Missing secret SFTP_USERNAME" && exit 1)
          test -n "${{ secrets.SFTP_PASSWORD }}"    || (echo "Missing secret SFTP_PASSWORD" && exit 1)
          test -n "${{ secrets.SFTP_PORT }}"        || (echo "Missing secret SFTP_PORT" && exit 1)
          test -n "${{ secrets.SFTP_TARGET }}"      || (echo "Missing secret SFTP_TARGET" && exit 1)

      - name: SSH cleanup target (wissen)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          script: |
            set -e
            cd "${{ secrets.SFTP_TARGET }}"
            rm -f index.html robots.txt sitemap.xml deploy-stamp.txt version.json
            rm -rf de en faq .deploy .deploy-stamp .hugo_build_lock

      - name: Deploy via SCP (wissen/public -> TARGET)
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          # Wichtig: Pfad relativ zum Repo-Root!
          source:   "wissen/public/**"
          target:   ${{ secrets.SFTP_TARGET }}
          # 'wissen/public' abstreifen => 2 Komponenten
          strip_components: 2
          overwrite: true

      - name: Done
        run: echo "Deployed to ${{ secrets.SFTP_TARGET }}"
