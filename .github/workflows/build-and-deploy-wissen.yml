# .github/workflows/build-and-deploy-wissen.yml
# Projekt: Vertäfelungen – Wissen (Hugo)
# Version: 2025-10-31 08:20 CET
# Änderungen:
# - Upload des Ordners 'public' verhindert (strip root): Inhalte werden in ./.deploy gespiegelt
# - Deploy direkt aus ./.deploy
# - Reparatur-Schritte robust (laufen nur, wenn Skripte vorhanden sind)
# - remote_path ausschließlich aus Secret SFTP_TARGET
# - Kein Artifact-Upload (Quota-Problem umgangen)

name: Build & Deploy Wissen (Hugo)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TZ: Europe/Berlin
      HUGO_ENV: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps for build utilities
        shell: bash
        run: |
          set -euo pipefail
          if [ -f requirements-ssot.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements-ssot.txt
          elif [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "Keine Python-Requirements gefunden – weiter."
          fi

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.134.1'
          extended: true

      # === Reparatur-Schritte (laufen nur, wenn vorhanden) ===
      - name: Frontmatter auto-fix
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          for f in tools/frontmatter_autofix.py tools/frontmatter-auto-fix.py tools/fm_autofix.py tools/fix_frontmatter.py; do
            if [[ -f "$f" ]]; then
              echo "Running $f"
              python "$f"
            fi
          done

      - name: Sanitize legacy YAML frontmatter
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          for f in tools/sanitize_yaml_frontmatter.py tools/sanitize-frontmatter.py tools/legacy_frontmatter_sanitize.py; do
            if [[ -f "$f" ]]; then
              echo "Running $f"
              python "$f"
            fi
          done

      - name: Fix legacy YAML formatting (flat → proper)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          for f in tools/fix_legacy_yaml_formatting.py tools/yaml_flat_to_proper.py tools/legacy_yaml_fix.py; do
            if [[ -f "$f" ]]; then
              echo "Running $f"
              python "$f"
            fi
          done

      # === Build ===
      - name: Build (minified)
        run: hugo --minify --gc

      # === Deploy-Payload vorbereiten: NUR Inhalte von ./public → ./.deploy ===
      - name: Prepare deploy payload (strip ./public root)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf ./.deploy
          mkdir -p ./.deploy
          # kopiert Inhalte von public/ (ohne die zusätzliche Ebene)
          cp -a ./public/. ./.deploy/
          # kleiner Marker zur Kontrolle
          date -u +%Y-%m-%dT%H:%M:%SZ > ./.deploy/.deploy-stamp

      # === Deploy ===
      - name: Check SFTP secrets
        id: s
        shell: bash
        env:
          SFTP_HOST:     ${{ secrets.SFTP_HOST }}
          SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_TARGET:   ${{ secrets.SFTP_TARGET }}
        run: |
          set -euo pipefail
          missing=()
          [[ -z "${SFTP_HOST:-}"     ]] && missing+=("SFTP_HOST")
          [[ -z "${SFTP_USERNAME:-}" ]] && missing+=("SFTP_USERNAME")
          [[ -z "${SFTP_PASSWORD:-}" ]] && missing+=("SFTP_PASSWORD")
          [[ -z "${SFTP_TARGET:-}"   ]] && missing+=("SFTP_TARGET")
          if (( ${#missing[@]} > 0 )); then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Fehlende Secrets: ${missing[*]} – Deploy wird übersprungen."
          else
            echo "ok=true" >> "$GITHUB_OUTPUT"
            echo "Alle erforderlichen SFTP-Secrets vorhanden."
          fi

      - name: Deploy via SFTP
        if: steps.s.outputs.ok == 'true'
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server:       ${{ secrets.SFTP_HOST }}
          port:         ${{ secrets.SFTP_PORT }}
          username:     ${{ secrets.SFTP_USERNAME }}
          password:     ${{ secrets.SFTP_PASSWORD }}
          local_path:   ./.deploy/
          # HINWEIS: Secret SFTP_TARGET = "holzvertaefelung-store/wissen" (ohne führenden Slash)
          # ODER absoluter htdocs-Pfad aus IONOS-Pfaddetails.
          remote_path:  ${{ secrets.SFTP_TARGET }}
          delete_remote_files: false
