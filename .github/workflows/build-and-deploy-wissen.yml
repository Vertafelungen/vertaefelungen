# build-and-deploy-wissen.yml
# Vertäfelungen – Wissen (Hugo)
# Version: 2026-01-23 12:37 CET
#
# CHANGELOG (2026-01-23):
# - Deploy-Fix: Dotfiles (insb. .htaccess) werden jetzt sicher mit ausgerollt.
#   Ursache: source "wissen/public/**" matched i. d. R. keine Dotfiles -> .htaccess fehlte live.
# - Added: Hard check that public/.htaccess exists after build (fails fast).
# - Added: Inspect step shows dotfiles (ls -la public).

name: Build & Deploy Wissen (Hugo)

on:
  push:
    branches: [ main ]
    paths:
      - 'wissen/**'
      - '.github/workflows/build-and-deploy-wissen.yml'
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wissen

    steps:
      - name: Checkout (mit Submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python 3.12 (für Hilfs-Tools)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache Hugo binary
        uses: actions/cache@v4
        with:
          path: wissen/tools/hugo
          key: hugo-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('wissen/tools/hugo/VERSION') }}

      - name: Install Hugo (repo-local)
        run: ./tools/hugo/install.sh

      - name: Pre-build mojibake scan (sources)
        run: |
          mkdir -p artifacts
          python scripts/scan_mojibake_sources.py --root content --mode pre --report artifacts/mojibake_prebuild_content.json || true
          if [ -f artifacts/mojibake_prebuild_content_summary.txt ]; then
            mv artifacts/mojibake_prebuild_content_summary.txt artifacts/mojibake_prebuild_summary.txt
          fi
          if [ -d "ssot" ]; then
            python scripts/scan_mojibake_sources.py --root ssot --mode pre --report artifacts/mojibake_prebuild_ssot.json || true
            if [ -f artifacts/mojibake_prebuild_ssot_summary.txt ]; then
              if [ -f artifacts/mojibake_prebuild_summary.txt ]; then
                echo "" >> artifacts/mojibake_prebuild_summary.txt
                echo "---- SSOT ----" >> artifacts/mojibake_prebuild_summary.txt
                cat artifacts/mojibake_prebuild_ssot_summary.txt >> artifacts/mojibake_prebuild_summary.txt
              else
                mv artifacts/mojibake_prebuild_ssot_summary.txt artifacts/mojibake_prebuild_summary.txt
              fi
            fi
          fi

      - name: Build (production)
        env:
          HUGO_ENV: production
        run: |
          ./tools/hugo/hugo --minify --gc --config "hugo.prod.toml"
          date -u +"%Y-%m-%dT%H:%M:%SZ  $GITHUB_SHA" > public/deploy-stamp.txt

      - name: Export retrieval index (Phase 6.1)
        run: |
          mkdir -p artifacts
          python scripts/export_retrieval_index.py --root public --report artifacts/retrieval_export_report.json

      - name: Verify retrieval export (Phase 6.1)
        run: python scripts/verify_retrieval_export.py

      - name: Generate content backlog (Phase 6.2)
        run: python scripts/generate_content_backlog.py

      # kleine Sicherung: zeige, dass der Build-Output da ist (inkl. Dotfiles)
      - name: Inspect build output
        run: |
          pwd
          du -sh public || true
          echo "== public (incl. dotfiles) =="
          ls -la public | head -n 200
          echo "== sample files =="
          find public -maxdepth 2 -type f | head -n 50

      # HARTE SICHERUNG: .htaccess muss im Build-Output existieren, sonst ist UTF-8 Fix live wirkungslos
      - name: Assert .htaccess is present in build output
        run: |
          test -f public/.htaccess || (echo "ERROR: public/.htaccess missing. Ensure wissen/static/.htaccess exists and is copied by Hugo." && exit 1)

      - name: Install guard dependencies
        run: npm ci

      - name: Run public output guards
        working-directory: ${{ github.workspace }}
        run: node wissen/scripts/guard_public_output.js

      - name: Post-build mojibake scan (public)
        run: |
          mkdir -p artifacts
          python scripts/scan_mojibake_sources.py --root public --mode post --report artifacts/mojibake_postbuild_public.json || true
          if [ -f artifacts/mojibake_postbuild_public_summary.txt ]; then
            mv artifacts/mojibake_postbuild_public_summary.txt artifacts/mojibake_postbuild_summary.txt
          fi

      - name: Run mojibake scan
        run: |
          python scripts/check_mojibake.py --root public --report artifacts/mojibake_report.json

      - name: Upload mojibake report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mojibake-report
          path: wissen/artifacts/mojibake_report.json

      - name: Upload retrieval export report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: retrieval-export-report
          path: wissen/artifacts/retrieval_export_report.json

      - name: Upload retrieval export verification report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: retrieval-export-verification-report
          path: wissen/scripts/reports/retrieval_export_verification_report.json

      - name: Upload content backlog artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: content-backlog
          path: |
            wissen/scripts/reports/content_backlog.de.md
            wissen/scripts/reports/content_backlog.en.md
            wissen/scripts/reports/content_backlog.json

      - name: Upload mojibake diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mojibake-diagnostics
          path: |
            wissen/artifacts/mojibake_prebuild_content.json
            wissen/artifacts/mojibake_prebuild_ssot.json
            wissen/artifacts/mojibake_prebuild_summary.txt
            wissen/artifacts/mojibake_postbuild_public.json
            wissen/artifacts/mojibake_postbuild_summary.txt

      - name: Check deploy secrets (hart brechen wenn was fehlt)
        run: |
          test -n "${{ secrets.SFTP_HOST }}"        || (echo "Missing secret SFTP_HOST" && exit 1)
          test -n "${{ secrets.SFTP_USERNAME }}"    || (echo "Missing secret SFTP_USERNAME" && exit 1)
          test -n "${{ secrets.SFTP_PASSWORD }}"    || (echo "Missing secret SFTP_PASSWORD" && exit 1)
          test -n "${{ secrets.SFTP_PORT }}"        || (echo "Missing secret SFTP_PORT" && exit 1)
          test -n "${{ secrets.SFTP_TARGET }}"      || (echo "Missing secret SFTP_TARGET" && exit 1)

      - name: SSH cleanup target (wissen)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          script: |
            set -e
            cd "${{ secrets.SFTP_TARGET }}"
            rm -rf faq/themen
            rm -f index.html robots.txt sitemap.xml deploy-stamp.txt version.json
            rm -rf de en faq .deploy .deploy-stamp .hugo_build_lock

      - name: Deploy via SCP (wissen/public -> TARGET) incl. dotfiles (.htaccess)
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          # Wichtig: Pfad relativ zum Repo-Root!
          # NOTE: Use directory source (NOT glob) to include dotfiles like .htaccess.
          source:   "wissen/public"
          target:   ${{ secrets.SFTP_TARGET }}
          # 'wissen/public' abstreifen => 2 Komponenten
          strip_components: 2
          overwrite: true

      - name: Done
        run: echo "Deployed to ${{ secrets.SFTP_TARGET }}"
