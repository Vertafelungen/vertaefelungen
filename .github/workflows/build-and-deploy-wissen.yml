name: Build & Deploy Wissen

on:
  push:
    branches: [ main ]
    paths:
      - 'scripts/build_site.py'                # Script liegt unter scripts/
      - 'de/oeffentlich/**'                    # DE-Content
      - 'en/public/**'                         # EN-Content
      - '.github/workflows/build-and-deploy-wissen.yml'
  workflow_dispatch:

env:
  # Ã–ffentlich erreichbare Basis-URL des Wissen-Bereichs
  BASE_URL: https://www.vertaefelungen.de/wissen
  # Wir bauen aus dem Repo-Root, damit DE und EN gefunden werden
  CONTENT_ROOT: .
  # Ordner, die NICHT gerendert werden sollen
  EXCLUDE_DIRS: .github,docs,interne-prozesse,internal-processes,general-information,scripts,tools

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install markdown pyyaml

      - name: Sanity check
        run: |
          ls -la
          test -f scripts/build_site.py || (echo "scripts/build_site.py fehlt" && exit 1)

      - name: Build site
        env:
          BASE_URL: ${{ env.BASE_URL }}
          CONTENT_ROOT: ${{ env.CONTENT_ROOT }}
          EXCLUDE_DIRS: ${{ env.EXCLUDE_DIRS }}
        run: |
          python scripts/build_site.py
          echo "Built output:"
          find site -maxdepth 3 -type f | head -n 100

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wissen-site
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wissen-site
          path: site

      # Deploy zum IONOS Webspace per SFTP (Secrets im Repo hinterlegen)
      - name: Deploy via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          port: ${{ secrets.SFTP_PORT }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          local_path: "site/*"
          remote_path: "www/wissen"   # ggf. anpassen, falls dein Zielpfad anders lautet
          sftp_only: true
