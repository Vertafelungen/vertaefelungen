name: Build & Deploy Wissen

on:
  push:
    branches: [ main ]
    paths:
      - 'de/**'
      - 'en/**'
      - 'scripts/build_site.py'
      - '.github/workflows/build-and-deploy-wissen.yml'
      - 'assets/**'
      - 'bilder/**'
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: build-deploy-wissen
  cancel-in-progress: true

env:
  BASE_URL: 'https://www.vertaefelungen.de/wissen'   # ohne Slash am Ende
  CONTENT_ROOT: '.'                                   # Repo-Root enth√§lt /de und /en
  EXCLUDE_DIRS: '.git,.github,.idea,.vscode,scripts'  # beim Parsen ignorieren

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install markdown pyyaml

      - name: Build site
        env:
          BASE_URL: ${{ env.BASE_URL }}
          CONTENT_ROOT: ${{ env.CONTENT_ROOT }}
          EXCLUDE_DIRS: ${{ env.EXCLUDE_DIRS }}
        run: |
          set -e
          python scripts/build_site.py
          echo "=== Ausgabe-Baum von ./site ==="
          python - << 'PY'
import os
for root, dirs, files in os.walk('site'):
    level = root.count(os.sep)
    indent = '  ' * level
    print(f"{indent}{os.path.basename(root) or root}/")
    for f in files:
        print(f"{indent}  {f}")
PY
          test -f site/index.html || echo "(Hinweis) Root-Startseite evtl. via Autoindex aus Unterordnern vorhanden"
          ls -la site || true

      - name: Deploy via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server:      ${{ secrets.SFTP_HOST }}
          port:        22
          username:    ${{ secrets.SFTP_USER }}
          password:    ${{ secrets.SFTP_PASSWORD }}
          local_path:  'site'                                # kompletter Ordner, nicht "site/*"
          remote_path: '/holzvertaefelung-store/wissen'      # Ziel auf dem IONOS-Webspace
          sftp_only:   true
          # delete_remote_files: true                        # optional: Ziel vor Upload leeren
