# build-and-deploy-wissen.yml
# Vertäfelungen – Wissen (Hugo)
# Version: 2025-11-02 10:19 CET

name: Build & Deploy Wissen (Hugo)

on:
  push:
    branches: [ main ]
    paths:
      - 'wissen/**'
      - '.github/workflows/build-and-deploy-wissen.yml'
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wissen

    steps:
      - name: Checkout (mit Submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python 3.12 (für Hilfs-Tools)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.128.2'
          extended: true

      - name: Build (production)
        env:
          HUGO_ENV: production
        run: |
          hugo --minify --gc --config "hugo.prod.toml"
          date -u +"%Y-%m-%dT%H:%M:%SZ  $GITHUB_SHA" > public/deploy-stamp.txt

      # kleine Sicherung: zeige, dass der Build-Output da ist
      - name: Inspect build output
        run: |
          pwd
          du -sh public || true
          find public -maxdepth 2 -type f | head -n 50

      - name: Check deploy secrets (hart brechen wenn was fehlt)
        run: |
          test -n "${{ secrets.SFTP_HOST }}"        || (echo "Missing secret SFTP_HOST" && exit 1)
          test -n "${{ secrets.SFTP_USERNAME }}"    || (echo "Missing secret SFTP_USERNAME" && exit 1)
          test -n "${{ secrets.SFTP_PASSWORD }}"    || (echo "Missing secret SFTP_PASSWORD" && exit 1)
          test -n "${{ secrets.SFTP_PORT }}"        || (echo "Missing secret SFTP_PORT" && exit 1)
          test -n "${{ secrets.SFTP_TARGET }}"      || (echo "Missing secret SFTP_TARGET" && exit 1)

      - name: SSH cleanup target (wissen)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          script: |
            set -e
            cd "${{ secrets.SFTP_TARGET }}"
            rm -f index.html robots.txt sitemap.xml deploy-stamp.txt version.json
            rm -rf de en faq .deploy .deploy-stamp .hugo_build_lock

      - name: Deploy via SCP (wissen/public -> TARGET)
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          # Wichtig: Pfad relativ zum Repo-Root!
          source:   "wissen/public/**"
          target:   ${{ secrets.SFTP_TARGET }}
          # 'wissen/public' abstreifen => 2 Komponenten
          strip_components: 2
          overwrite: true

      - name: Done
        run: echo "Deployed to ${{ secrets.SFTP_TARGET }}"
