name: Build & Deploy Wissen (Hugo)

on:
  push:
    branches: [ main ]
    paths:
      - 'wissen/**'
      - 'static/**'
      - 'content/**'
      - 'themes/**'
      - 'config.yml'
      - 'hugo.*.toml'
      - 'hugo.toml'
      - 'hugo.dev.toml'
      - 'hugo.prod.toml'
  workflow_dispatch:

concurrency:
  group: wissen-deploy
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python deps for build utilities (optional)
        if: ${{ hashFiles('requirements-ssot.txt') != '' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ssot.txt

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.128.0'
          extended: true

      # Optional: eigene Vorverarbeitungs-/Fix-Schritte hier einfügen
      # - name: Frontmatter auto-fix
      #   run: python tools/whatever.py

      - name: Build (minified)
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
        run: |
          hugo --minify --gc

      - name: Check deploy secrets
        run: |
          test -n "${{ secrets.SFTP_HOST }}"      || (echo 'Missing secret SFTP_HOST' && exit 1)
          test -n "${{ secrets.SFTP_USERNAME }}"      || (echo 'Missing secret SFTP_USERNAME' && exit 1)
          test -n "${{ secrets.SFTP_PASSWORD }}"  || (echo 'Missing secret SFTP_PASSWORD' && exit 1)
          test -n "${{ secrets.SFTP_PORT }}"      || (echo 'Missing secret SFTP_PORT' && exit 1)
          test -n "${{ secrets.SFTP_TARGET }}"    || (echo 'Missing secret SFTP_TARGET' && exit 1)
          echo "Secrets OK. Deploy target: ${{ secrets.SFTP_TARGET }}"

      # --- Cleanup direkt im Zielordner (nur Altlasten, .htaccess bleibt bestehen) ---
      - name: SSH cleanup target (${{ secrets.SFTP_TARGET }})
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          script: |
            set -e
            echo "Vorher in ${{ secrets.SFTP_TARGET }}:"
            ls -la "${{ secrets.SFTP_TARGET }}" || true

            # Altlasten entfernen – .htaccess bleibt
            rm -rf \
              "${{ secrets.SFTP_TARGET }}/de" \
              "${{ secrets.SFTP_TARGET }}/en" \
              "${{ secrets.SFTP_TARGET }}/assets" \
              "${{ secrets.SFTP_TARGET }}/site" \
              "${{ secrets.SFTP_TARGET }}/public" \
              "${{ secrets.SFTP_TARGET }}/index.html" \
              "${{ secrets.SFTP_TARGET }}/sitemap.xml" \
              "${{ secrets.SFTP_TARGET }}/version.json" \
              "${{ secrets.SFTP_TARGET }}/robots.txt" || true

            echo "Nachher in ${{ secrets.SFTP_TARGET }}:"
            ls -la "${{ secrets.SFTP_TARGET }}" || true

      # --- Upload: nur die Inhalte von public/* → /wissen (SFTP_TARGET) ---
      - name: Deploy via SCP (copy public/* → ${{ secrets.SFTP_TARGET }})
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          source: "public/*"
          target: "${{ secrets.SFTP_TARGET }}/"
          overwrite: true
