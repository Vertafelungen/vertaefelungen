# build-and-deploy-wissen.yml
# Vertäfelungen – Wissen (Hugo)
# Version: 2025-11-02 10:09 CET

name: Build & Deploy Wissen (Hugo)

on:
  push:
    branches: [ main ]
    paths:
      - 'wissen/**'
      - '.github/workflows/build-and-deploy-wissen.yml'
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wissen

    steps:
      - name: Checkout (mit Submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python 3.12 (für Hilfs-Tools)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.128.2'
          extended: true

      - name: Build (production)
        env:
          HUGO_ENV: production
        run: |
          # Immer die Produktions-Config nutzen
          hugo --minify --gc --config "hugo.prod.toml"
          # sichtbarer Zeitstempel
          date -u +"%Y-%m-%dT%H:%M:%SZ  $GITHUB_SHA" > public/deploy-stamp.txt

      - name: Check deploy secrets (hart brechen wenn was fehlt)
        run: |
          test -n "${{ secrets.SFTP_HOST }}"        || (echo "Missing secret SFTP_HOST" && exit 1)
          test -n "${{ secrets.SFTP_USERNAME }}"    || (echo "Missing secret SFTP_USERNAME" && exit 1)
          test -n "${{ secrets.SFTP_PASSWORD }}"    || (echo "Missing secret SFTP_PASSWORD" && exit 1)
          test -n "${{ secrets.SFTP_PORT }}"        || (echo "Missing secret SFTP_PORT" && exit 1)
          test -n "${{ secrets.SFTP_TARGET }}"      || (echo "Missing secret SFTP_TARGET" && exit 1)

      # Vorsichtige Zielbereinigung: nur Inhalte im Wissen-Ordner
      - name: SSH cleanup target (wissen)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          script: |
            set -e
            cd "${{ secrets.SFTP_TARGET }}"
            # Entferne alte Artefakte, aber lass den Ordner und .htaccess existieren
            rm -f index.html robots.txt sitemap.xml deploy-stamp.txt version.json
            rm -rf de en faq .deploy .deploy-stamp .hugo_build_lock

      - name: Deploy via SCP (public/* -> TARGET)
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port:     ${{ secrets.SFTP_PORT }}
          source:   "public/*"
          target:   ${{ secrets.SFTP_TARGET }}
          strip_components: 1
          overwrite: true

      - name: Done
        run: echo "Deployed to ${{ secrets.SFTP_TARGET }}"
