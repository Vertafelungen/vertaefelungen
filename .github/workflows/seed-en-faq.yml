name: Seed EN FAQ from DE

on:
  workflow_dispatch:
    inputs:
      apply:
        description: "Write files (true) or dry-run (false)"
        required: true
        default: "false"
      force:
        description: "Overwrite existing EN files"
        required: true
        default: "false"
      limit:
        description: "Max number of files to create (0 = no limit)"
        required: true
        default: "0"

permissions:
  contents: write

concurrency:
  group: seed-en-faq
  cancel-in-progress: true

jobs:
  seed:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wissen
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps (slugify, ruamel.yaml, etc.)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-ssot.txt ]; then
            pip install -r requirements-ssot.txt
          else
            pip install python-slugify ruamel.yaml
          fi

      - name: Seed EN FAQ (dry-run or apply)
        id: seed
        env:
          APPLY: ${{ github.event.inputs.apply }}
          FORCE: ${{ github.event.inputs.force }}
          LIMIT: ${{ github.event.inputs.limit }}
        run: |
          set -e
          ARGS=""
          if [ "$APPLY" = "true" ]; then ARGS="$ARGS --apply"; fi
          if [ "$FORCE" = "true" ]; then ARGS="$ARGS --force"; fi
          if [ "$LIMIT" != "0" ]; then ARGS="$ARGS --limit $LIMIT"; fi
          echo "Running: python scripts/faq_seed_en_from_de.py $ARGS"
          python scripts/faq_seed_en_from_de.py $ARGS

      - name: Commit seeded files
        if: ${{ github.event.inputs.apply == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "seed(en/faq): create English FAQ stubs from DE [skip ci]"
            git push
          fi

      # Optional: sofort reparieren/vereinheitlichen (idempotent)
      - name: Repair & mark FAQ content
        if: ${{ github.event.inputs.apply == 'true' }}
        run: |
          python scripts/faq_repair_and_mark.py
          git add -A
          if git diff --cached --quiet; then
            echo "No FAQ repair changes."
          else
            git commit -m "fix(faq): normalize EN/FAQ (frontmatter, url, slug)"
            git push
          fi

      # Optional: Guard pr√ºfen (gesamt), damit du direkt Feedback bekommst
      - name: Guard validation (strict, all content)
        run: |
          python scripts/guard_validate.py --mode all
