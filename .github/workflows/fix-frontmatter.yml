name: One-off: Fix Frontmatter (BOM/Control)
on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Write helper script
        run: |
          mkdir -p wissen/scripts
          cat > wissen/scripts/fix_frontmatter.py <<'PY'
          #!/usr/bin/env python3
          # Version: 2025-10-07 14:05 Europe/Berlin
          from __future__ import annotations
          from pathlib import Path
          import re, sys
          ROOT = Path(__file__).resolve().parents[1]
          CONTENT = ROOT / "content"
          CTRL_RE = re.compile(r'[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]')
          BOM = "\ufeff"
          def sanitize(s: str) -> str:
              if not s: return s
              s = s.replace(BOM, "")
              s = CTRL_RE.sub(" ", s)
              s = s.replace("\r\n", "\n")
              return s
          def pull_last_sync_into_frontmatter(txt: str) -> str:
              import re
              m = re.match(r'^---\n(.*?\n)---\n(.*)$', txt, flags=re.S)
              if not m: return txt
              fm, body = m.group(1), m.group(2)
              ms = re.search(r'^\s*last_sync:\s*".*?"\s*$', body, flags=re.M)
              if ms and "last_sync:" not in fm:
                  fm = fm.rstrip("\n") + "\n" + ms.group(0) + "\n"
                  body = body[:ms.start()] + body[ms.end():]
              return f"---\n{fm}---\n{body.lstrip()}"
          def fix_file(p: Path) -> bool:
              raw = p.read_text(encoding="utf-8", errors="replace")
              fixed = sanitize(raw)
              fixed = pull_last_sync_into_frontmatter(fixed)
              if fixed != raw:
                  p.write_text(fixed, encoding="utf-8")
                  print(f"[FIX] {p}")
                  return True
              return False
          def main():
              md_files = list((ROOT / "content").rglob("*.md"))
              changed = 0
              for f in md_files:
                  peek = f.read_text(encoding="utf-8", errors="replace")[:4]
                  if "---" not in peek and "\ufeff---" not in peek: continue
                  if fix_file(f): changed += 1
              print(f"âœ“ repariert: {changed} Dateien")
          if __name__ == "__main__":
              sys.exit(main())
          PY

      - name: Run fix
        run: python wissen/scripts/fix_frontmatter.py

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "fix(frontmatter): sanitize all Markdown (BOM/control + last_sync in YAML)"
            git push
          else
            echo "No changes."
          fi
