name: Sync + Build-Fix + Deploy Wissen

on:
  push:
    branches: [ main ]
    paths:
      - 'de/**'
      - 'en/**'
      - 'scripts/**'
      - 'wissen/**'
      - 'assets/**'
      - 'robots.txt'
      - 'sitemap.xml'
      - '.github/workflows/sync-build-deploy-wissen.yml'
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: build-deploy-wissen
  cancel-in-progress: true

env:
  SFTP_TARGET: /wissen

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # --- SYNC aus Google Sheet ---
      # DE
      - name: Sync from Sheet (DE)
        env:
          LANG: de
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL_DE }} # oder nutze GSHEET_ID/GSHEET_GID
        run: |
          python "scripts/sync-from-sheet-hugo.py"

      # EN
      - name: Sync from Sheet (EN)
        env:
          LANG: en
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL_EN }} # oder nutze GSHEET_ID/GSHEET_GID
        run: |
          python "scripts/sync-from-sheet-hugo.py"

      # --- BUILD-FIX: index.html + localhost-Links bereinigen ---
      - name: Write /wissen/index.html (Redirect → /wissen/de/)
        run: |
          mkdir -p wissen
          cat > wissen/index.html <<'HTML'
          <!doctype html>
          <html lang="de">
          <head>
            <meta charset="utf-8">
            <title>Wissensdatenbank | Vertäfelung & Lambris</title>
            <link rel="canonical" href="/wissen/de/">
            <meta http-equiv="refresh" content="0; url=/wissen/de/">
          </head>
          <body>
            <p>Weiterleitung zur <a href="/wissen/de/">deutschen Übersicht</a> …</p>
          </body>
          </html>
          HTML
          echo "✓ /wissen/index.html geschrieben"

      - name: Strip localhost links (sanitize)
        shell: python
        run: |
          import re, sys
          from pathlib import Path
          roots = [Path("wissen"), Path("de"), Path("en"), Path("assets")]
          pat = re.compile(r"(https?://)?(localhost|127\.0\.0\.1)(:\d+)?", re.I)
          base_re = re.compile(r'(<base\s+href=)["\'](.*?)["\']', re.I)
          cnt = 0
          for root in roots:
              if not root.exists(): 
                  continue
              for p in root.rglob("*"):
                  if p.is_file() and p.suffix.lower() in {".html",".htm",".xml",".json",".txt",".md"}:
                      try:
                          txt = p.read_text(encoding="utf-8")
                      except UnicodeDecodeError:
                          try:
                              txt = p.read_text(encoding="latin-1")
                          except Exception:
                              continue
                      orig = txt
                      # base href auf /wissen/ setzen, falls localhost
                      def _fix_base(m):
                          href = m.group(2)
                          if "localhost" in href or "127.0.0.1" in href:
                              return f'{m.group(1)}"/wissen/"'
                          return m.group(0)
                      txt = base_re.sub(_fix_base, txt)
                      # Hostanteile entfernen
                      txt = pat.sub("", txt)
                      if txt != orig:
                          p.write_text(txt, encoding="utf-8")
                          cnt += 1
          print(f"Sanitized files:", cnt)

      - name: List payload
        run: |
          ls -la
          ls -la wissen || true
          ls -la de || true
          ls -la en || true

      # --- DEPLOY nach IONOS per SFTP ---
      - name: SFTP Deploy
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server:   ${{ secrets.SFTP_HOST }}
          port:     ${{ secrets.SFTP_PORT || 22 }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          sftp_only: true
          local_path: |
            wissen/**
            de/**
            en/**
            assets/**
            robots.txt
            sitemap.xml
          remote_path: ${{ env.SFTP_TARGET }}

      # Hinweis: CHMOD via SFTP ist auf Shared-Hosting oft nicht möglich.
      # Falls Rechte falsch sind, im IONOS Webspace-Explorer manuell 644/755 setzen.
