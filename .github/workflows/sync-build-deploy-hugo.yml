# .github/workflows/sync-build-deploy-wissen.yml
# Version: v2025-09-24 17:45
# Pipeline: Sync (GS-Sheet) → Build-Fix (index + localhost clean) → Deploy (IONOS /wissen)

name: Sync + Build-Fix + Deploy Wissen

on:
  push:
    branches: [ main ]
    paths:
      - 'de/**'
      - 'en/**'
      - 'wissen/**'
      - 'assets/**'
      - 'robots.txt'
      - 'sitemap.xml'
      - 'scripts/**'
      - 'sync-from-sheet-hugo.py'
      - '.github/workflows/sync-build-deploy-wissen.yml'
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: build-deploy-wissen
  cancel-in-progress: true

env:
  SFTP_TARGET: /wissen

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # --- Script autodetect: sucht an beiden typischen Orten und mit beiden Namen ---
      - name: Detect sync script path
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          CANDIDATES=(
            "scripts/sync-from-sheet-hugo.py"
            "sync-from-sheet-hugo.py"
            "scripts/sync-from-sheet.py"
            "sync-from-sheet.py"
          )
          FOUND=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then FOUND="$p"; break; fi
          done
          if [ -z "$FOUND" ]; then
            echo "❌ Kein Sync-Script gefunden."; ls -la; exit 1
          fi
          echo "path=$FOUND" >> "$GITHUB_OUTPUT"
          echo "✓ Sync-Script: $FOUND"

      # --- SYNC aus Google Sheet ---
      - name: Sync from Sheet (DE)
        env:
          LANG: de
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL_DE }}
        run: |
          set -euo pipefail
          python "${{ steps.detect.outputs.path }}"

      - name: Sync from Sheet (EN)
        env:
          LANG: en
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL_EN }}
        run: |
          set -euo pipefail
          python "${{ steps.detect.outputs.path }}"

      # --- BUILD-FIX: index.html + localhost-Links bereinigen ---
      - name: Write /wissen/index.html (Redirect → /wissen/de/)
        run: |
          set -euo pipefail
          mkdir -p wissen
          cat > wissen/index.html <<'HTML'
          <!doctype html>
          <html lang="de">
          <head>
            <meta charset="utf-8">
            <title>Wissensdatenbank | Vertäfelung & Lambris</title>
            <link rel="canonical" href="/wissen/de/">
            <meta http-equiv="refresh" content="0; url=/wissen/de/">
          </head>
          <body>
            <p>Weiterleitung zur <a href="/wissen/de/">deutschen Übersicht</a> …</p>
          </body>
          </html>
          HTML
          echo "✓ /wissen/index.html geschrieben"

      - name: Strip localhost links (sanitize)
        shell: python
        run: |
          import re
          from pathlib import Path
          roots = [Path("wissen"), Path("de"), Path("en"), Path("assets")]
          host = re.compile(r"(https?://)?(localhost|127\.0\.0\.1)(:\d+)?", re.I)
          base = re.compile(r'(<base\s+href=)["\'](.*?)["\']', re.I)
          changed = 0
          for root in roots:
              if not root.exists(): 
                  continue
              for p in root.rglob("*"):
                  if p.is_file() and p.suffix.lower() in {".html",".htm",".xml",".json",".txt",".md"}:
                      try:
                          txt = p.read_text(encoding="utf-8")
                      except UnicodeDecodeError:
                          try:
                              txt = p.read_text(encoding="latin-1")
                          except Exception:
                              continue
                      orig = txt
                      # base href korrigieren, falls localhost
                      def _fix_base(m):
                          href = m.group(2)
                          if "localhost" in href or "127.0.0.1" in href:
                              return f'{m.group(1)}"/wissen/"'
                          return m.group(0)
                      txt = base.sub(_fix_base, txt)
                      # Hostanteile von localhost/127.0.0.1 entfernen (Pfad bleibt)
                      txt = host.sub("", txt)
                      if txt != orig:
                          p.write_text(txt, encoding="utf-8")
                          changed += 1
          print(f"✓ localhost-Links bereinigt in {changed} Datei(en)")

      - name: List payload
        run: |
          echo "::group::Root"
          ls -la
          echo "::endgroup::"
          echo "::group::wissen"
          ls -la wissen || true
          echo "::endgroup::"
          echo "::group::de"
          ls -la de || true
          echo "::endgroup::"
          echo "::group::en"
          ls -la en || true
          echo "::endgroup::"

      # --- DEPLOY nach IONOS per SFTP ---
      - name: SFTP Deploy
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server:   ${{ secrets.SFTP_HOST }}
          port:     ${{ secrets.SFTP_PORT || 22 }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          sftp_only: true
          remote_path: ${{ env.SFTP_TARGET }}
          local_path: |
            wissen/**
            de/**
            en**
            assets/**
            robots.txt
            sitemap.xml
      # Hinweis: CHMOD via SFTP ist auf Shared-Hosting oft nicht möglich.
      # Falls Rechte falsch sind, im IONOS Webspace-Explorer 644/755 setzen.
