# 22.09.2025 11:02 – Sync → Build → Deploy (Hugo / wissen)
name: Sync → Build → Deploy (Hugo / wissen)

on:
  workflow_dispatch:
  schedule:
    - cron: "17 * * * *"

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.diffcheck.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install pandas requests

      - name: Sync DE
        env:
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL }}
          LANG: de
          CONTENT_DIR: wissen/content/de
        run: python scripts/sync-from-sheet-hugo.py

      - name: Sync EN
        env:
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL }}
          LANG: en
          CONTENT_DIR: wissen/content/en
        run: python scripts/sync-from-sheet-hugo.py

      - name: Git stage
        run: |
          git config user.name  "gh-bot"
          git config user.email "gh-bot@users.noreply.github.com"
          git add wissen/content

      - name: Detect changes
        id: diffcheck
        run: |
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.diffcheck.outputs.changed == 'true'
        run: |
          git commit -m "content: sync from sheet (Hugo) – $(date -u +'%Y-%m-%d %H:%M')"
          git push

  build_deploy:
    runs-on: ubuntu-latest
    needs: sync
    if: needs.sync.result == 'success' && needs.sync.outputs.changed == 'true'
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "0.146.0"
          extended: true

      # ⬇️ Build NICHT ins Repo-Root und NICHT nach 'public', sondern in 'site/'
      - name: Build (Hugo → ./site)
        run: hugo --source wissen --destination site --minify

      - name: Verify build output
        run: |
          echo "Listing ./site:"
          test -d site && ls -lah site || (echo "site missing" && exit 1)
          echo "Top-level files in site:"
          ls -lah site | head -n 50

      # Optional: Root-Index prüfen (hilfreich, wenn /wissen → /wissen/de/ leiten soll)
      - name: Ensure root index exists (informational)
        run: |
          if [ ! -f site/index.html ]; then
            echo "WARN: site/index.html fehlt – /wissen könnte ohne Redirect 404/500 zeigen."
          fi

      # --- Remote-Verzeichnis sicherstellen + Preflight-Listing ---
      - name: Ensure remote dir exists & preflight ls
        env:
          SFTP_HOST:     ${{ secrets.SFTP_HOST }}
          SFTP_PORT:     ${{ secrets.SFTP_PORT }}
          SFTP_USER:     ${{ secrets.SFTP_USER }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_TARGET:   ${{ secrets.SFTP_TARGET }}   # Muss '/wissen' sein
        run: |
          set -e
          if [ -z "${SFTP_TARGET}" ]; then
            echo "ERROR: SFTP_TARGET is EMPTY"; exit 1
          fi

          echo "SFTP_TARGET length: ${#SFTP_TARGET}"
          echo "SFTP_TARGET prefix: ${SFTP_TARGET:0:8}..."
          echo "SFTP_TARGET suffix: ...${SFTP_TARGET: -8}"

          case "${SFTP_TARGET}" in
            /*) echo "SFTP_TARGET looks absolute ✓" ;;
            *)  echo "ERROR: SFTP_TARGET must start with '/'" ; exit 1 ;;
          esac

          sudo apt-get update -y >/dev/null
          sudo apt-get install -y sshpass >/dev/null

          echo "Create/ensure target directory exists:"
          sshpass -p "$SFTP_PASSWORD" ssh -p "${SFTP_PORT:-22}" -o StrictHostKeyChecking=no \
            "$SFTP_USER@$SFTP_HOST" "mkdir -p '${SFTP_TARGET}' && stat -c %F '${SFTP_TARGET}' || true"

          echo "Preflight: list target directory (masked):"
          echo "ls -la \"${SFTP_TARGET}\"" \
            | sshpass -p "$SFTP_PASSWORD" sftp -P "${SFTP_PORT:-22}" -o StrictHostKeyChecking=no "$SFTP_USER@$SFTP_HOST"

      # --- Deploy NUR die Inhalte von ./site → /wissen (kein zusätzlicher Ordnername) ---
      - name: Deploy via SFTP (→ /wissen)
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server:   ${{ secrets.SFTP_HOST }}
          port:     22
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: "site/*"                     # Inhalte von site/ hochladen
          remote_path: "${{ secrets.SFTP_TARGET }}/"  # z. B. /wissen/
          delete_remote_files: true
          sftp_only: true
