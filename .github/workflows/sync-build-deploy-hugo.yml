name: Sync → Build → Deploy (Hugo / wissen)

on:
  workflow_dispatch:
  schedule:
    - cron: "17 * * * *"

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.diffcheck.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install pandas requests

      - name: Sync DE
        env:
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL }}
          LANG: de
          CONTENT_DIR: wissen/content/de
        run: python scripts/sync-from-sheet-hugo.py

      - name: Sync EN
        env:
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL }}
          LANG: en
          CONTENT_DIR: wissen/content/en
        run: python scripts/sync-from-sheet-hugo.py

      - name: Git stage
        run: |
          git config user.name  "gh-bot"
          git config user.email "gh-bot@users.noreply.github.com"
          git add wissen/content

      - name: Detect changes
        id: diffcheck
        run: |
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.diffcheck.outputs.changed == 'true'
        run: |
          git commit -m "content: sync from sheet (Hugo) – $(date -u +'%Y-%m-%d %H:%M')"
          git push

  build_deploy:
    runs-on: ubuntu-latest
    needs: sync
    if: needs.sync.result == 'success' && needs.sync.outputs.changed == 'true'
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "0.146.0"
          extended: true

      # >>> Wichtig: im Source-Ordner bauen und Ausgabe ins Repo-Root/./site legen
      - name: Build (Hugo → ../site)
        working-directory: wissen
        run: |
          rm -rf ../site
          hugo --minify -d ../site

      - name: Verify build output
        run: |
          echo "Listing ./site:"
          test -d ./site && ls -lah ./site || (echo "site missing" && exit 1)
          echo "Top-level files in site:"
          ls -lah ./site | head -n 50

      # (Optional) index.html im Root /wissen platzieren (SEO + kurze Klickfolge)
      - name: Ensure root index exists (informational)
        run: |
          if [ -f ./site/index.html ]; then
            echo "Root index present in site."
          else
            echo "No root index.html generated by Hugo."
          fi

      # Preflight: Zielpfad ausgeben und checken
      - name: Ensure remote dir exists & preflight ls
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_TARGET: ${{ secrets.SFTP_TARGET }}
        run: |
          set -e
          echo "SFTP_TARGET length: $(echo -n "$SFTP_TARGET" | wc -c)"
          echo "SFTP_TARGET: $SFTP_TARGET"

          # Muss absolut beginnen
          case "$SFTP_TARGET" in
            /*) echo "SFTP_TARGET looks absolute ✓" ;;
            *) echo "ERROR: SFTP_TARGET must start with '/'"; exit 1 ;;
          esac

          echo "Create/ensure target directory exists:"
          sshpass -p "$SFTP_PASSWORD" sftp -o StrictHostKeyChecking=no -P "${SFTP_PORT:-22}" "$SFTP_USER@$SFTP_HOST" <<EOF
          -mkdir $SFTP_TARGET
          -mkdir $SFTP_TARGET/public
          -ls $SFTP_TARGET
          EOF

      - name: Deploy via SFTP (→ /wissen)
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server:   ${{ secrets.SFTP_HOST }}
          port:     ${{ secrets.SFTP_PORT || 22 }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: "site/*"
          remote_path: "${{ secrets.SFTP_TARGET }}"
          delete_remote_files: true  # Achtung: löscht alles unterhalb des Targets
          sftp_only: true

      - name: Post Checkout (with submodules)
        if: always()
        run: echo "Done."
