name: One-off: Repair YAML header delimiters

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  repair:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Repair delimiters & sanitize heads (inline Python)
        shell: bash
        run: |
          python - <<'PY'
          import os, re, sys, io, pathlib

          ROOT = pathlib.Path(".")
          CONTENT_DIRS = [
              ROOT / "wissen" / "content",
          ]

          # Zeichen, die im YAML-Header gerne Ärger machen
          ZERO_WIDTH = [
              "\ufeff",  # BOM
              "\u200b", "\u200c", "\u200d", "\u2060",  # Zero width chars
              "\xa0",    # NBSP
          ]
          CONTROL_BAD = dict.fromkeys(range(0x00, 0x20), None)
          # ^ entfernt Steuerzeichen 0x00-0x1F (Zeilenumbrüche behandeln wir separat)

          def clean_header_text(s: str) -> str:
              for z in ZERO_WIDTH:
                  s = s.replace(z, "")
              # Steuerzeichen (außer \n, \r, \t) aus dem Header entfernen
              s = s.translate(CONTROL_BAD)
              # „Smart quotes“ in ASCII-Quotes wandeln
              s = s.replace("“","\"").replace("”","\"").replace("‘","'").replace("’","'")
              # En/Em-Dash in Bindestrich
              s = s.replace("–","-").replace("—","-")
              return s

          fm_open = re.compile(r"^(\*{3}|-{3})\s*$")        # *** oder ---
          fm_close = re.compile(r"^-{3}\s*$")               # ---
          yaml_kv   = re.compile(r"^[A-Za-z0-9_][A-Za-z0-9_\-]*\s*:\s*.*$")

          changed_files = []

          def process_file(p: pathlib.Path):
              try:
                  raw = p.read_bytes()
                  text = raw.decode("utf-8", errors="replace")
              except Exception:
                  return

              orig = text
              lines = text.splitlines(True)  # keepends

              # Bom/Zero width vorne entfernen
              if lines:
                  lines[0] = clean_header_text(lines[0])

              if not lines:
                  return

              # Prüfen, ob es wie ein YAML-Header beginnt
              if not fm_open.match(lines[0].strip()):
                  # Falls *** statt --- verwendet wird
                  if lines[0].strip() == "***":
                      lines[0] = "---\n"
                  else:
                      # Kein Frontmatter vorhanden -> nichts tun
                      return

              # Jetzt beginnt Header sicher
              # Öffnende Linie normalisieren
              if lines[0].strip() == "***":
                  lines[0] = "---\n"
              elif lines[0].strip() != "---":
                  lines[0] = "---\n"

              # Header bis zum schließenden --- suchen
              i = 1
              header_end = -1
              while i < len(lines):
                  # Header-Zeile sanitizen
                  lines[i] = clean_header_text(lines[i])

                  if fm_close.match(lines[i].strip()):
                      header_end = i
                      break

                  # Falls die Zeile eindeutig kein YAML-KV mehr ist, brechen wir ab
                  if not yaml_kv.match(lines[i].strip()) and lines[i].strip() != "":
                      break
                  i += 1

              # Wenn kein schließendes --- gefunden wurde, einfügen
              if header_end == -1:
                  # Suche nach erster Leerzeile nach dem (vermutlichen) Header
                  insert_at = i
                  while insert_at < len(lines) and lines[insert_at].strip() != "":
                      insert_at += 1
                  lines.insert(insert_at, "---\n")
                  header_end = insert_at

              # Sicherstellen, dass nach dem Header eine Leerzeile kommt
              if header_end + 1 < len(lines) and lines[header_end + 1].strip() != "":
                  lines.insert(header_end + 1, "\n")

              new_text = "".join(lines)
              if new_text != orig:
                  p.write_text(new_text, encoding="utf-8", newline="\n")
                  changed_files.append(str(p))

          for content_root in CONTENT_DIRS:
              if not content_root.exists():
                  continue
              for p in content_root.rglob("*.md"):
                  process_file(p)

          print(f"Repaired files: {len(changed_files)}")
          for f in changed_files:
              print("  FIX:", f)
          PY

      - name: Commit & push (only if changed)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: repair YAML frontmatter delimiters and sanitize headers"
            git push
          else
            echo "No changes."
          fi
