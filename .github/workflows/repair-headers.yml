---
name: One-off: Repair YAML header delimiters

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  repair:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Repair delimiters & sanitize heads (inline Python)
        shell: bash
        run: |
          python - <<'PY'
          import os, re, pathlib

          ROOT = pathlib.Path(".")
          CONTENT_DIRS = [ ROOT / "wissen" / "content" ]

          ZERO_WIDTH = ["\ufeff","\u200b","\u200c","\u200d","\u2060","\xa0"]
          CONTROL_BAD = dict.fromkeys(range(0x00,0x20), None)

          def clean_header_text(s: str) -> str:
              for z in ZERO_WIDTH:
                  s = s.replace(z, "")
              s = s.translate(CONTROL_BAD)
              s = s.replace("“","\"").replace("”","\"").replace("‘","'").replace("’","'")
              s = s.replace("–","-").replace("—","-")
              return s

          fm_open  = re.compile(r"^(\*{3}|-{3})\s*$")   # *** oder ---
          fm_close = re.compile(r"^-{3}\s*$")           # ---
          yaml_kv  = re.compile(r"^[A-Za-z0-9_][A-Za-z0-9_\-]*\s*:\s*.*$")

          changed = []

          def process_md(p: pathlib.Path):
              try:
                  text = p.read_text(encoding="utf-8", errors="replace")
              except Exception:
                  return
              orig = text
              lines = text.splitlines(True)

              if not lines:
                  return

              # erste Zeile säubern
              lines[0] = clean_header_text(lines[0])

              if not fm_open.match(lines[0].strip()):
                  if lines[0].strip() == "***":
                      lines[0] = "---\n"
                  else:
                      return  # kein Frontmatter

              if lines[0].strip() != "---":
                  lines[0] = "---\n"

              i = 1
              header_end = -1
              while i < len(lines):
                  lines[i] = clean_header_text(lines[i])
                  if fm_close.match(lines[i].strip()):
                      header_end = i
                      break
                  if not yaml_kv.match(lines[i].strip()) and lines[i].strip() != "":
                      break
                  i += 1

              if header_end == -1:
                  insert_at = i
                  while insert_at < len(lines) and lines[insert_at].strip() != "":
                      insert_at += 1
                  lines.insert(insert_at, "---\n")
                  header_end = insert_at

              if header_end + 1 < len(lines) and lines[header_end + 1].strip() != "":
                  lines.insert(header_end + 1, "\n")

              new_text = "".join(lines)
              if new_text != orig:
                  p.write_text(new_text, encoding="utf-8", newline="\n")
                  changed.append(str(p))

          for root in CONTENT_DIRS:
              if root.exists():
                  for md in root.rglob("*.md"):
                      process_md(md)

          print(f"Repaired files: {len(changed)}")
          for f in changed:
              print("  FIX:", f)
          PY

      - name: Commit & push (only if changed)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: repair YAML frontmatter delimiters and sanitize headers"
            git push
          else
            echo "No changes."
          fi
