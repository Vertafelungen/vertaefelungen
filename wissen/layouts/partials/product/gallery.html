{{/* 
File: wissen/layouts/partials/product/gallery.html
Version: 2025-12-28 18:00 CET

Wichtig:
- Wir nutzen Permalinks f체r Bilder, um mit canonifyURLs und baseURL-Pfaden keine doppelten Pr채fixe wie /wissen/wissen/ zu erzeugen.
- Priorit채t: SSOT (.Params.produkt.bilder) -> Fallback: Page Resources (Leaf Bundle)
*/}}

{{- $items := slice -}}

{{- /* 1) SSOT: .Params.produkt.bilder */ -}}
{{- with .Params.produkt.bilder -}}
  {{- range . -}}
    {{- $fn := .datei | default "" -}}
    {{- if $fn -}}

      {{- $res := $.Resources.GetMatch $fn -}}
      {{- $src := "" -}}

      {{- if $res -}}
        {{- /* Permalink bewahrt das korrekte /wissen/-Pr채fix ohne Verdopplung. */ -}}
        {{- $src = $res.Permalink -}}
      {{- else -}}
        {{- /* Fallback: Datei relativ zum Seitenordner */ -}}
        {{- $pageBase := strings.TrimSuffix $.Permalink "/" -}}
        {{- $src = printf "%s/%s" $pageBase $fn -}}
      {{- end -}}

      {{- $alt := "" -}}
      {{- if eq $.Lang "de" -}}
        {{- $alt = (or .alt_de .alt_en $.Title) -}}
      {{- else -}}
        {{- $alt = (or .alt_en .alt_de $.Title) -}}
      {{- end -}}

      {{- $items = $items | append (dict "src" $src "alt" $alt) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* 2) Fallback: alle Page Resources images */ -}}
{{- if not $items -}}
  {{- with .Resources.Match "*.{png,jpg,jpeg,webp}" -}}
    {{- range . -}}
      {{- $items = $items | append (dict "src" .Permalink "alt" $.Title) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $items -}}
<div class="product-gallery">
  {{- range $items -}}
    <figure class="product-gallery__item">
      <img
        src="{{ .src | safeURL }}"
        alt="{{ .alt | plainify | safeHTMLAttr }}"
        loading="lazy"
        decoding="async"
      />
    </figure>
  {{- end -}}
</div>
{{- end -}}
