{{/* 
File: wissen/layouts/partials/product/gallery.html
Version: 2025-12-28 18:00 CET

Wichtig:
- KEIN absURL auf RelPermalink/Resource-URLs (verhindert /wissen/wissen/)
- Priorität: SSOT (.Params.produkt.bilder) -> Fallback: Page Resources (Leaf Bundle)
*/}}

{{- $items := slice -}}

{{- /* 1) SSOT: .Params.produkt.bilder */ -}}
{{- with .Params.produkt.bilder -}}
  {{- range . -}}
    {{- $fn := .datei | default "" -}}
    {{- if $fn -}}

      {{- $res := $.Resources.GetMatch $fn -}}
      {{- $src := "" -}}

      {{- if $res -}}
        {{- /* RelPermalink ist bereits korrekt (enthält in Prod /wissen/) */ -}}
        {{- $src = $res.RelPermalink -}}
      {{- else -}}
        {{- /* Fallback: Datei relativ zum Seitenordner */ -}}
        {{- $src = printf "%s%s" $.RelPermalink $fn -}}
      {{- end -}}

      {{- $alt := "" -}}
      {{- if eq $.Lang "de" -}}
        {{- $alt = (or .alt_de .alt_en $.Title) -}}
      {{- else -}}
        {{- $alt = (or .alt_en .alt_de $.Title) -}}
      {{- end -}}

      {{- $items = $items | append (dict "src" $src "alt" $alt) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* 2) Fallback: alle Page Resources images */ -}}
{{- if not $items -}}
  {{- with .Resources.ByType "image" -}}
    {{- range . -}}
      {{- $items = $items | append (dict "src" .RelPermalink "alt" $.Title) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $items -}}
<div class="product-gallery">
  {{- range $items -}}
    <figure class="product-gallery__item">
      <img
        src="{{ .src | safeURL }}"
        alt="{{ .alt | plainify | safeHTMLAttr }}"
        loading="lazy"
        decoding="async"
      />
    </figure>
  {{- end -}}
</div>
{{- end -}}
