{{/*
File: wissen/layouts/partials/product/gallery.html
Version: 2026-01-10 10:20 CET

Wichtig:
- Wir nutzen ausschließlich Page Resources (Leaf Bundle).
- Wir nutzen Permalinks für Bilder, um mit canonifyURLs und baseURL-Pfaden keine doppelten Präfixe wie /wissen/wissen/ zu erzeugen.
*/}}

{{- $altScratch := newScratch -}}
{{- $orderedFiles := slice -}}
{{- with .Params.produkt.bilder -}}
  {{- range . -}}
    {{- $fn := .datei | default "" -}}
    {{- if $fn -}}
      {{- $alt := "" -}}
      {{- if eq $.Lang "de" -}}
        {{- $alt = (or .alt_de .alt_en "") -}}
      {{- else -}}
        {{- $alt = (or .alt_en .alt_de "") -}}
      {{- end -}}
      {{- $altScratch.Set $fn $alt -}}
      {{- $orderedFiles = $orderedFiles | append $fn -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $galleryItems := slice -}}
{{- if gt (len $orderedFiles) 0 -}}
  {{- range $orderedFiles -}}
    {{- $resource := $.Resources.GetMatch . -}}
    {{- if $resource -}}
      {{- $galleryItems = $galleryItems | append (dict "resource" $resource "filename" .) -}}
    {{- else -}}
      {{- warnf "Missing product image resource %q for %s" . $.RelPermalink -}}
      {{- $galleryItems = $galleryItems | append (dict "resource" nil "filename" .) -}}
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{- $fallback := .Resources.Match "*.{png,jpg,jpeg,webp}" -}}
  {{- range sort $fallback "Name" -}}
    {{- $galleryItems = $galleryItems | append (dict "resource" . "filename" (path.Base .Name)) -}}
  {{- end -}}
{{- end -}}

{{- if gt (len $galleryItems) 0 -}}
<div class="product-gallery">
  {{- range $galleryItems -}}
    {{- $resource := .resource -}}
    {{- $filename := .filename -}}
    {{- $alt := $altScratch.Get $filename -}}
    {{- if not $alt -}}
      {{- $stem := strings.TrimSuffix $filename (path.Ext $filename) -}}
      {{- $alt = replace (replace $stem "-" " ") "_" " " -}}
    {{- end -}}
    <figure class="product-gallery__item{{ if not $resource }} product-gallery__item--missing{{ end }}">
      {{- if $resource -}}
        <img
          src="{{ $resource.Permalink | safeURL }}"
          alt="{{ $alt | plainify | safeHTMLAttr }}"
          loading="lazy"
          decoding="async"
        />
      {{- else -}}
        <div class="product-gallery__placeholder" role="img" aria-label="{{ if eq $.Lang "de" }}Bild fehlt im Bundle{{ else }}Image missing in bundle{{ end }}">
          <span>{{ if eq $.Lang "de" }}Bild fehlt im Bundle{{ else }}Image missing in bundle{{ end }}</span>
        </div>
      {{- end -}}
    </figure>
  {{- end -}}
</div>
{{- end -}}
